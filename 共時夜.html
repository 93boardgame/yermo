<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>共時夜 - Synch Village Night</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Firebase SDK (模組化版本) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, doc, setDoc, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // 設定 Log Level
        // setLogLevel('debug'); // 開發時可開啟

        // --- Firebase 環境變數 ---
        // 注意：在本地測試時，請確保 __firebase_config 變數存在，或手動填入您的 Config
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // 將 Firebase 工具掛載到全局
        window.fb = {
            auth, db, appId, initialAuthToken,
            getFirestore, collection, addDoc, onSnapshot, serverTimestamp, doc, setDoc, getDoc,
            signInWithCustomToken, signInAnonymously, onAuthStateChanged
        };
        
        // 觸發應用程式初始化
        document.addEventListener('DOMContentLoaded', () => {
            if (window.initApp) window.initApp();
        });
    </script>
    <style>
        /* 自定義樣式 */
        .scrollbar-thin { scrollbar-width: thin; scrollbar-color: #374151 #0f172a; }
        .scrollbar-thin::-webkit-scrollbar { width: 8px; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background-color: #374151; border-radius: 4px; }
        .scrollbar-thin::-webkit-scrollbar-track { background-color: #0f172a; }
        @keyframes pulse { 0%, 100% { opacity: 0.4; } 50% { opacity: 0.8; } }
        .animate-star-pulse { animation: pulse 3s infinite ease-in-out; }
        body { font-family: 'Inter', system-ui, sans-serif; }
    </style>
</head>
<body class="min-h-screen bg-slate-950 text-slate-200 relative overflow-hidden flex flex-col items-center justify-center p-6 selection:bg-amber-900 selection:text-white">

    <!-- 主應用程式容器 -->
    <div id="app-container" class="max-w-md w-full relative z-10 flex flex-col items-center">
        <!-- 初始 Loading 畫面 -->
        <div class="text-center py-20">
            <svg class="w-6 h-6 text-slate-500 mx-auto mb-4 animate-spin" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
            <p class="text-slate-400 tracking-widest font-serif text-lg">正在確認時間脈絡...</p>
        </div>
    </div>

    <!-- Footer -->
    <div class="absolute bottom-4 w-full px-4 flex justify-between items-end">
        <div class="w-8"></div>
        <div class="text-[10px] text-slate-700 font-light tracking-widest uppercase text-center">
            Designed by Ye Mo · Space for Silence
        </div>
        <div class="w-8 flex justify-end">
            <button id="admin-trigger" class="text-slate-800 hover:text-slate-600 transition-colors p-2" title="Admin Access">
                <svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
            </button>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="admin-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50 backdrop-blur-sm p-4">
        <div class="bg-slate-900 border border-slate-700 p-6 rounded-lg w-full max-w-xs relative">
            <button id="close-admin-modal" class="absolute top-2 right-2 text-slate-500 hover:text-white">
                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            </button>
            <h4 class="text-amber-50 mb-4 font-serif text-center">後台通行證</h4>
            <form id="admin-login-form">
                <input type="password" id="admin-password" class="w-full bg-slate-950 border border-slate-800 rounded px-3 py-2 text-white mb-3 text-center tracking-widest placeholder:text-slate-700" placeholder="請輸入密碼" autofocus />
                <button type="submit" class="w-full bg-amber-900/50 hover:bg-amber-800 text-amber-100 py-2 rounded text-sm">確認</button>
                <p class="text-[10px] text-slate-600 text-center mt-3">預設密碼: 8888</p>
            </form>
        </div>
    </div>

    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- 角色資料 ---
            const ROLES = [
                { id: 'drifter', name: '漂行者', engName: 'The Drifter', quote: '你可以在風裡移動，不需要留下任何痕跡。', desc: '你的心有些浮動，想換個節奏，卻找不到降落的地方。在這裡，你不需要解釋自己。', behavior: '走動、觀察，坐一會再離開。', mission: '【安置彼此的節奏】在空間中移動，若看見角落的潛聽者，可選擇輕輕坐下靜默片刻，或許留下一張「這裡讓我想停一下」的小卡。', color: 'from-blue-200 to-slate-300' },
                { id: 'listener', name: '潛聽者', engName: 'The Deep Listener', quote: '靜下來，你會聽見時間的聲音。', desc: '你需要距離與空白。不想被打擾，只想安靜整理自己，讓思緒像塵埃落下。', behavior: '找個角落，閱讀、沈思、與空氣共處。', mission: '【照見與守護】若有人靠近，只需輕輕點頭。你也許會收到一張寫著「我在聽」的紙條，請收下它，成為被理解的象徵。', color: 'from-indigo-300 to-purple-300' },
                { id: 'resonator', name: '共感者', engName: 'The Resonator', quote: '不是話語連結我們，是感覺的共鳴。', desc: '你渴望被理解、想連結，但厭倦了無意義的寒暄。你用靈魂的觸角感知他人。', behavior: '用眼神與微笑邀請交流，也可默默聆聽語句。', mission: '【傳遞無聲信號】若感覺到了連結，可寫下一句「我在聽，雖然不說話」留給需要的人；或在共時簿上留下你的感受。', color: 'from-rose-200 to-orange-200' },
                { id: 'keeper', name: '記光者', engName: 'The Light Keeper', quote: '把你感受到的靜默，寫成一點光留下來。', desc: '你的內在有很多感受想梳理。你是夜晚的翻譯者，想留下一些永恆的什麼。', behavior: '在「共時簿」寫下句子、圖像、回聲。', mission: '【將漂浮的句子落地】觀察牆面或窗邊的便利貼，若被某句話觸動，請用你的文字或圖像回應它，創造沈默的回聲。', color: 'from-amber-100 to-yellow-200' }
            ];

            // --- 應用程式狀態 ---
            let state = {
                user: null,
                authReady: false,
                step: 'loading',
                selectedRole: null,
                lastDrawStatus: null,
                email: '',
                isLoading: false,
                isAdminUnlocked: false,
                isRegistrationOpen: true,
                guestList: []
            };

            const appContainer = document.getElementById('app-container');
            const getTodayDateString = () => new Date().toISOString().slice(0, 10);

            // 更新狀態並渲染
            const setState = (newState) => {
                state = { ...state, ...newState };
                renderUI();
            };

            // 產生背景星星
            const generateStars = () => {
                const starCount = 50;
                let starsHtml = '';
                for (let i = 0; i < starCount; i++) {
                    const style = `top: ${Math.random() * 100}%; left: ${Math.random() * 100}%; width: ${Math.random() * 2 + 1}px; height: ${Math.random() * 2 + 1}px; animation-duration: ${Math.random() * 3 + 2}s; animation-delay: ${Math.random() * 2}s;`;
                    starsHtml += `<div class="absolute bg-white rounded-full opacity-40 animate-star-pulse" style="${style}"></div>`;
                }
                const wrapper = document.createElement('div');
                wrapper.className = "absolute inset-0 overflow-hidden pointer-events-none";
                wrapper.innerHTML = starsHtml + '<div class="absolute top-0 left-1/2 -translate-x-1/2 w-[600px] h-[600px] bg-indigo-900/20 rounded-full blur-3xl -z-10"></div>';
                document.body.prepend(wrapper);
            };

            const getCurrentRoleColor = () => {
                const role = state.selectedRole || ROLES.find(r => r.name === state.lastDrawStatus?.roleName);
                return role ? role.color : 'from-slate-400 to-slate-500';
            };

            // --- Firebase 邏輯 ---

            // 1. 檢查抽卡狀態 (Private Data)
            const checkDrawStatus = async (userId) => {
                if (!userId) return false;
                const { db, appId, getDoc, doc } = window.fb;
                const todayDate = getTodayDateString();
                const drawStatusRef = doc(db, 'artifacts', appId, 'users', userId, 'user_data', 'draw_status');
                
                try {
                    const docSnap = await getDoc(drawStatusRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.lastDrawDate === todayDate) {
                            setState({ lastDrawStatus: data, step: 'limited' });
                            return true;
                        }
                    }
                    setState({ lastDrawStatus: null, step: 'intro' });
                    return false;
                } catch (error) {
                    console.error("Check status failed:", error);
                    setState({ lastDrawStatus: null, step: 'intro' });
                    return false;
                }
            };

            // 2. 設置即時監聽 (Public Config/Data)
            const setupRealtimeListeners = (userId) => {
                const { db, appId, onSnapshot, doc, collection } = window.fb;

                // 監聽活動配置
                const configRef = doc(db, 'artifacts', appId, 'public', 'config');
                onSnapshot(configRef, (docSnap) => {
                    const isOpen = docSnap.exists() ? docSnap.data().isOpen !== false : true;
                    setState({ isRegistrationOpen: isOpen });
                }, (err) => console.log("Config error", err));

                // 管理員監聽名單
                if (state.isAdminUnlocked && userId) {
                    const q = collection(db, 'artifacts', appId, 'public', 'data', 'guest_list');
                    onSnapshot(q, (snapshot) => {
                        const guests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                            .sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                        setState({ guestList: guests });
                    }, (err) => console.error("Admin data error", err));
                }
            };

            // 3. 抽卡
            const handleDraw = async () => {
                if (!state.user || !state.user.uid || state.lastDrawStatus) return;
                setState({ step: 'drawing' });
                
                let count = 0;
                const interval = setInterval(() => {
                    const randomRole = ROLES[Math.floor(Math.random() * ROLES.length)];
                    setState({ selectedRole: randomRole });
                    count++;
                    if (count > 10) {
                        clearInterval(interval);
                        const finalRole = ROLES[Math.floor(Math.random() * ROLES.length)];
                        setState({ selectedRole: finalRole });
                        
                        // 儲存狀態
                        const { db, appId, doc, setDoc, serverTimestamp } = window.fb;
                        const userId = state.user.uid;
                        const todayDate = getTodayDateString();
                        const newStatus = { roleId: finalRole.id, roleName: finalRole.name, lastDrawDate: todayDate, timestamp: serverTimestamp() };
                        
                        setState({ lastDrawStatus: newStatus });
                        setDoc(doc(db, 'artifacts', appId, 'users', userId, 'user_data', 'draw_status'), newStatus, { merge: true });
                        setTimeout(() => setState({ step: 'result' }), 500);
                    }
                }, 150);
            };

            // 4. 提交 Email
            const handleEmailSubmit = async (email) => {
                if (!state.user || !email || !state.selectedRole) return;
                setState({ isLoading: true });
                try {
                    const { db, appId, addDoc, collection, serverTimestamp } = window.fb;
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'guest_list'), {
                        email: email,
                        roleId: state.selectedRole.id,
                        roleName: state.selectedRole.name,
                        createdAt: serverTimestamp(),
                        device: navigator.userAgent
                    });
                    setState({ step: 'success' });
                } catch (error) {
                    showCustomMessage("錯誤", "傳送失敗，請稍後再試。");
                } finally {
                    setState({ isLoading: false });
                }
            };

            // 5. 管理員功能
            const toggleRegistration = async () => {
                if (!state.user) return;
                try {
                    const { db, appId, doc, setDoc } = window.fb;
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'config'), { isOpen: !state.isRegistrationOpen }, { merge: true });
                } catch (error) { showCustomMessage("錯誤", "設定失敗"); }
            };

            const copyEmails = () => {
                const emails = state.guestList.map(g => g.email).join(', ');
                navigator.clipboard.writeText(emails).then(() => showCustomMessage('成功', '已複製')).catch(() => showCustomMessage('失敗', '無法複製'));
            };

            // --- UI 渲染 ---
            const renderLogo = (isSmall) => `
                <div class="transition-all duration-1000 ${isSmall ? 'scale-75 mb-4' : 'scale-100 mb-8'}">
                    <div class="relative group">
                        <div class="absolute inset-0 bg-amber-100 blur-xl opacity-20 group-hover:opacity-40 transition-opacity duration-1000"></div>
                        <div class="w-20 h-20 bg-gradient-to-br from-amber-50 to-slate-200 rounded-full shadow-[0_0_40px_rgba(251,191,36,0.3)] flex items-center justify-center border border-slate-700/30">
                            <svg class="w-8 h-8 text-slate-800 opacity-80" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
                        </div>
                    </div>
                </div>
                <h1 class="text-xl tracking-[0.3em] font-serif text-amber-50/80 mb-2 text-center uppercase">Synch Village Night</h1>
                <h2 class="text-3xl font-serif text-white tracking-widest mb-10 text-center border-b border-slate-800 pb-4 w-full">共時夜</h2>
            `;

            const renderUI = () => {
                if (state.isAdminUnlocked) { appContainer.innerHTML = renderAdminPanel(); attachListeners(); return; }

                let content = '';
                
                if (state.step === 'loading') {
                    content = `<div class="text-center py-20 animate-pulse"><svg class="w-6 h-6 text-slate-500 mx-auto mb-4 animate-spin" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg><p class="text-slate-400 tracking-widest font-serif text-lg">正在確認時間脈絡...</p></div>`;
                } else if (state.step === 'intro') {
                    content = `
                        ${renderLogo(false)}
                        <div class="text-center space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-700">
                            <div class="space-y-4 text-slate-300 leading-relaxed font-light">
                                <p>也許你最近，<br/>每次滑手機就覺得更煩。</p>
                                <p>下班後只想靜靜發呆，<br/>卻找不到一個能喘口氣的地方。</p>
                                <div class="pt-4 border-t border-slate-800/50">
                                    <p class="text-slate-200">不為了認識誰、也不為了變得更好<br/>只為了讓你在某一個夜裡，<br/>可以好好存在。</p>
                                    <p class="pt-4 text-amber-100/90 font-serif text-lg">與夜共時，你會有興趣嗎？</p>
                                </div>
                            </div>
                            <div class="pt-8">
                                <button id="draw-button" class="group relative px-8 py-3 bg-slate-900 border border-slate-700 rounded-full overflow-hidden hover:border-amber-200/50 transition-all duration-500">
                                    <div class="absolute inset-0 w-0 bg-amber-900/20 transition-all duration-[250ms] ease-out group-hover:w-full"></div>
                                    <span class="relative text-amber-50 tracking-widest text-sm flex items-center gap-2">
                                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></svg>
                                        抽出今夜的角色
                                    </span>
                                </button>
                            </div>
                        </div>`;
                } else if (state.step === 'limited') {
                    content = `
                        ${renderLogo(false)}
                        <div class="text-center space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-700 bg-slate-900/60 backdrop-blur-sm border border-slate-800 p-8 rounded-xl shadow-2xl">
                            <svg class="w-10 h-10 text-amber-200/70 mx-auto" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
                            <h3 class="text-2xl font-serif text-white mb-2">時間之牆</h3>
                            <div class="space-y-4 text-slate-300 leading-relaxed font-light">
                                <p>今日的你為：</p>
                                <p class="text-4xl font-serif text-transparent bg-clip-text bg-gradient-to-r ${getCurrentRoleColor()} mb-2 font-bold">${state.lastDrawStatus?.roleName}</p>
                                <p class="pt-4 text-amber-100/90 font-serif">明天的你，又是什麼角色呢？<br/>我們明天見！</p>
                            </div>
                            <p class="text-xs text-slate-500 font-serif tracking-widest pt-4">下次共時時刻：<br/> ${new Date(new Date().getTime() + 86400000).toLocaleDateString('zh-TW')}</p>
                        </div>`;
                } else if (state.step === 'drawing') {
                    content = `
                        ${renderLogo(true)}
                        <div class="text-center py-20 animate-pulse">
                            <p class="text-slate-400 tracking-widest font-serif text-lg">正在聆聽夜的聲音...</p>
                            <div class="mt-8 text-2xl font-serif text-slate-600 transition-all duration-150 min-h-[40px]">${state.selectedRole?.name || ''}</div>
                        </div>`;
                } else if (state.step === 'result' && state.selectedRole) {
                    const role = state.selectedRole;
                    const btn = state.isRegistrationOpen 
                        ? `<button id="get-invite-button" class="w-full py-3 bg-amber-900/30 hover:bg-amber-900/50 border border-amber-900/50 hover:border-amber-700 text-amber-100 rounded-lg transition-all duration-300 text-sm tracking-wider flex items-center justify-center gap-2"><svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg> 領取免費體驗邀請</button>` 
                        : `<button disabled class="w-full py-3 bg-slate-800/50 border border-slate-700 text-slate-500 rounded-lg cursor-not-allowed text-sm tracking-wider flex items-center justify-center gap-2"><svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg> 本場次邀請名額已滿</button>`;
                    
                    content = `
                        ${renderLogo(true)}
                        <div class="w-full bg-slate-900/60 backdrop-blur-sm border border-slate-800 p-8 rounded-xl shadow-2xl animate-in fade-in zoom-in-95 duration-500">
                            <div class="text-center mb-6"><span class="text-xs text-amber-200/60 tracking-[0.2em] uppercase block mb-1">Your Role Tonight</span><h3 class="text-3xl font-serif text-transparent bg-clip-text bg-gradient-to-r ${getCurrentRoleColor()} mb-2">${role.name}</h3><p class="text-sm text-slate-400 font-serif italic">${role.engName}</p></div>
                            <div class="space-y-6"><blockquote class="text-center text-lg text-slate-200 font-serif leading-relaxed border-l-2 border-slate-700 pl-4 py-2 italic">「${role.quote}」</blockquote><div class="space-y-4 text-sm text-slate-300 font-light leading-relaxed"><p>${role.desc}</p><div class="bg-slate-800/50 p-4 rounded-lg border border-slate-700/50"><h4 class="text-amber-200 text-xs tracking-wider mb-2 flex items-center gap-2"><svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></svg> 今夜任務</h4><p class="text-slate-200">${role.mission}</p></div></div></div>
                            <div class="mt-8 pt-6 border-t border-slate-800 flex flex-col gap-3">${btn}</div>
                        </div>`;
                } else if (state.step === 'email') {
                    content = `
                        ${renderLogo(true)}
                        <div class="w-full bg-slate-900/60 backdrop-blur-sm border border-slate-800 p-8 rounded-xl animate-in fade-in slide-in-from-right-4 duration-500">
                            <div class="text-center mb-6"><h3 class="text-xl font-serif text-white mb-2">留下微光</h3><p class="text-sm text-slate-400 font-light">我們將選出第一批「${state.selectedRole?.name}」<br/>免費邀請你參與首場共時夜。</p></div>
                            <form id="email-form" class="space-y-4">
                                <div><label class="block text-xs text-slate-500 uppercase tracking-wider mb-2">Email Address</label><input type="email" id="email-input" required placeholder="name@example.com" class="w-full bg-slate-950 border border-slate-800 rounded-lg px-4 py-3 text-slate-200 focus:outline-none focus:border-amber-900/50 focus:ring-1 focus:ring-amber-900/50 transition-all placeholder:text-slate-700" value="${state.email}"></div>
                                <button type="submit" ${state.isLoading ? 'disabled' : ''} class="w-full py-3 bg-gradient-to-r from-amber-900/40 to-slate-900 border border-amber-900/30 hover:border-amber-500/50 text-amber-50 rounded-lg transition-all duration-300 text-sm tracking-wider mt-4 flex items-center justify-center gap-2 group disabled:opacity-50">
                                    ${state.isLoading ? '<span>傳送中...</span>' : `<span>發送邀請訊號</span><svg class="w-3 h-3 group-hover:translate-x-1 transition-transform" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" x2="11" y1="2" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>`}
                                </button>
                                <button type="button" id="back-to-result-button" class="w-full text-center text-xs text-slate-600 hover:text-slate-400 mt-4">返回角色卡</button>
                            </form>
                        </div>`;
                } else if (state.step === 'success') {
                    content = `
                        ${renderLogo(true)}
                        <div class="text-center py-10 animate-in zoom-in-90 duration-700">
                            <div class="w-16 h-16 bg-slate-800/50 rounded-full flex items-center justify-center mx-auto mb-6 border border-slate-700"><svg class="w-6 h-6 text-amber-100" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg></div>
                            <h3 class="text-2xl font-serif text-white mb-4">訊號已接收</h3>
                            <p class="text-slate-300 font-light leading-relaxed mb-8">謝謝你，${state.selectedRole?.name}。<br/>願今夜的風，吹散你的疲憊。<br/>若有緣分，我們將會在信箱與你相遇。</p>
                            <p class="text-xs text-slate-500 font-serif tracking-widest mt-12">SYNCH VILLAGE NIGHT</p>
                            <button id="back-to-intro-button" class="mt-8 text-xs text-slate-600 hover:text-slate-400 border-b border-transparent hover:border-slate-600 transition-all">回到入口</button>
                        </div>`;
                }

                appContainer.innerHTML = content;
                attachListeners();
            };

            const renderAdminPanel = () => {
                const guests = state.guestList;
                const statusColor = state.isRegistrationOpen ? 'bg-emerald-900/20 border-emerald-800' : 'bg-rose-900/20 border-rose-800';
                const statusText = state.isRegistrationOpen ? 'text-emerald-400' : 'text-rose-400';
                
                const listHtml = guests.length === 0 ? '<p class="text-center text-slate-500 py-8">目前尚無資料</p>' : guests.map(g => `
                    <div class="bg-slate-800/50 p-3 rounded border border-slate-700/50 flex justify-between items-center">
                        <div><p class="text-amber-50 font-mono text-sm">${g.email}</p><p class="text-xs text-slate-400 mt-1">${g.roleName} • ${g.createdAt ? new Date(g.createdAt.seconds * 1000).toLocaleString('zh-TW', {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'}) : '剛剛'}</p></div>
                        <div class="w-2 h-2 rounded-full ${g.roleId==='drifter'?'bg-blue-300':g.roleId==='listener'?'bg-indigo-400':g.roleId==='resonator'?'bg-rose-300':'bg-yellow-200'}"></div>
                    </div>`).join('');

                return `
                    <div class="w-full max-w-lg bg-slate-900 border border-slate-700 rounded-xl p-6 shadow-2xl animate-in fade-in slide-in-from-bottom-4">
                        <div class="flex justify-between items-center mb-6 border-b border-slate-700 pb-4">
                            <h3 class="text-xl font-serif text-amber-100 flex items-center gap-2"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg> 訪客名單 (${guests.length})</h3>
                            <button id="logout-admin-button" class="text-slate-500 hover:text-white"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>
                        </div>
                        <div class="mb-6 p-4 rounded-lg border flex items-center justify-between transition-colors ${statusColor}">
                            <div><h4 class="text-sm font-bold flex items-center gap-2 ${statusText}"><svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"/><line x1="12" x2="12" y1="2" y2="12"/></svg> 活動狀態：${state.isRegistrationOpen?'報名開放中':'報名已截止'}</h4><p class="text-xs text-slate-400 mt-1">${state.isRegistrationOpen?'使用者可以填寫 Email':'使用者將看到截止公告'}</p></div>
                            <button id="toggle-registration-button" class="px-4 py-2 rounded text-xs font-bold transition-all ${state.isRegistrationOpen?'bg-rose-900/50 text-rose-200 hover:bg-rose-800 border border-rose-700':'bg-emerald-900/50 text-emerald-200 hover:bg-emerald-800 border border-emerald-700'}">${state.isRegistrationOpen?'關閉報名':'開啟報名'}</button>
                        </div>
                        <div class="max-h-[50vh] overflow-y-auto space-y-3 pr-2 scrollbar-thin">${listHtml}</div>
                        <div class="mt-6 pt-4 border-t border-slate-700 flex gap-3"><button id="copy-emails-button" class="flex-1 bg-slate-800 hover:bg-slate-700 text-slate-200 py-2 rounded text-sm transition-colors flex items-center justify-center gap-2"><svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg> 複製所有 Email</button></div>
                    </div>`;
            };

            const attachListeners = () => {
                const bind = (id, fn) => { const el = document.getElementById(id); if (el) el.onclick = fn; };
                bind('draw-button', handleDraw);
                bind('get-invite-button', () => setState({ step: 'email' }));
                bind('back-to-result-button', () => setState({ step: 'result', email: '' }));
                bind('back-to-intro-button', () => setState({ step: 'intro', email: '' }));
                bind('logout-admin-button', () => setState({ isAdminUnlocked: false, step: 'intro' }));
                bind('toggle-registration-button', toggleRegistration);
                bind('copy-emails-button', copyEmails);
                
                const form = document.getElementById('email-form');
                if (form) form.onsubmit = (e) => { e.preventDefault(); handleEmailSubmit(document.getElementById('email-input').value); };
            };

            const showCustomMessage = (title, msg) => {
                const el = document.createElement('div');
                el.className = "fixed top-4 left-1/2 -translate-x-1/2 bg-slate-700 text-white p-3 rounded-lg shadow-xl z-50 text-sm transition-opacity duration-300 opacity-0";
                el.innerHTML = `<strong>${title}:</strong> ${msg}`;
                document.body.appendChild(el);
                setTimeout(() => el.style.opacity = '1', 10);
                setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, 3000);
            };

            // --- 初始化 ---
            const adminModal = document.getElementById('admin-modal');
            document.getElementById('admin-trigger').onclick = () => adminModal.classList.remove('hidden');
            document.getElementById('close-admin-modal').onclick = () => adminModal.classList.add('hidden');
            document.getElementById('admin-login-form').onsubmit = (e) => {
                e.preventDefault();
                if (document.getElementById('admin-password').value === '8888') {
                    adminModal.classList.add('hidden');
                    setState({ isAdminUnlocked: true });
                    setupRealtimeListeners(state.user?.uid);
                } else showCustomMessage('錯誤', '密碼錯誤');
            };

            generateStars();

            window.initApp = async () => {
                const { auth, signInWithCustomToken, signInAnonymously } = window.fb;
                let user = auth.currentUser;
                
                if (!user) {
                    try {
                        if (window.fb.initialAuthToken) await signInWithCustomToken(auth, window.fb.initialAuthToken);
                        else await signInAnonymously(auth);
                        user = auth.currentUser;
                    } catch (e) { console.error("Sign-in error", e); }
                }

                if (user) {
                    setState({ user, authReady: true });
                    setupRealtimeListeners(user.uid);
                    await checkDrawStatus(user.uid);
                } else {
                    setState({ user: null, authReady: true, step: 'intro' });
                    setupRealtimeListeners(null);
                }
                
                renderUI();
            };

            if (window.fb) window.initApp();
        });
    </script>
</body>
</html>