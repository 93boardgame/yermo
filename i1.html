<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iäººå¤œåº— | Introvert's Night</title>
    <!-- å¼•å…¥ FontAwesome ç”¨æ–¼åœ–ç¤º -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #050505;
            --card-bg: #121212;
            --text-main: #e0e0e0;
            --text-muted: #888;
            --accent: #6200ea; /* æ·±ç´« */
            --accent-glow: #b388ff; /* äº®ç´« */
            --danger: #cf6679;
            --success: #03dac6;
            --font-family: 'Helvetica Neue', Arial, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            /* èƒŒæ™¯å¾®ç²’æ•ˆæœ */
            background-image: radial-gradient(circle at 50% 50%, #1a0b2e 0%, #000000 100%);
        }

        #app {
            width: 100%;
            max-width: 480px; /* æ‰‹æ©Ÿç‰ˆå‹ */
            padding: 20px;
            box-sizing: border-box;
            position: relative;
            padding-bottom: 80px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* é é¢åˆ‡æ›å‹•ç•« */
        .page { display: none; flex: 1; animation: fadeIn 0.6s cubic-bezier(0.22, 1, 0.36, 1); }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* é€šç”¨å…ƒä»¶ */
        h1, h2, h3 { font-weight: 300; letter-spacing: 2px; text-align: center; margin: 0 0 20px 0; }
        h1 { color: var(--accent-glow); text-shadow: 0 0 15px rgba(98, 0, 234, 0.6); margin-bottom: 40px; margin-top: 20px;}
        h2 { font-size: 1.5rem; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
        
        .btn {
            background: linear-gradient(135deg, var(--accent), #3700b3);
            color: white;
            border: none;
            padding: 16px;
            width: 100%;
            border-radius: 50px; /* åœ“è§’æ›´æŸ”å’Œ */
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
            transition: 0.3s;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(98, 0, 234, 0.3);
        }
        .btn:active { transform: scale(0.96); }
        .btn:disabled { background: #333; color: #666; cursor: not-allowed; box-shadow: none; }
        
        .btn.outline { background: transparent; border: 1px solid #444; color: var(--text-muted); box-shadow: none; }
        .btn.outline:hover { border-color: var(--text-main); color: var(--text-main); }
        
        .btn.staff { 
            background: #222; 
            border: 1px dashed #555; 
            font-size: 14px; 
            color: #666; 
            box-shadow: none; 
            margin-top: 40px;
        }

        /* åˆ—è¡¨æ¨£å¼ */
        .list-item {
            background: var(--card-bg);
            padding: 18px;
            margin-bottom: 12px;
            border-radius: 12px;
            cursor: pointer;
            border: 1px solid #222;
            transition: 0.3s;
            text-align: center;
            font-size: 18px;
        }
        .list-item:hover { border-color: var(--accent); background: #1e1e2d; }

        /* å€åŸŸä»‹ç´¹å¡ç‰‡ */
        .zone-card {
            background: var(--card-bg);
            padding: 24px;
            margin-bottom: 25px;
            border-radius: 16px;
            border: 1px solid #222;
            position: relative;
            overflow: hidden;
        }
        .zone-card::before {
            content: ''; position: absolute; top:0; left:0; width: 4px; height: 100%; background: var(--accent);
        }
        .zone-title { font-size: 20px; color: var(--accent-glow); margin-bottom: 12px; font-weight: bold; }
        .zone-desc { font-size: 14px; color: #aaa; line-height: 1.8; margin-bottom: 15px; white-space: pre-wrap; }
        
        /* å€å¡Šæ¨™ç±¤ */
        .label-block { display: block; font-size: 12px; color: var(--accent); margin-top: 8px; font-weight: bold; }

        /* åº§ä½é¸æ“‡ */
        .seat-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 30px;
            justify-items: center;
        }
        .seat {
            width: 50px; height: 50px;
            background: #222;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            border: 2px solid #333;
            transition: 0.2s;
            position: relative;
        }
        /* æ–¹æ¡Œæ¨£å¼ */
        .seat.square { border-radius: 8px; }
        
        .seat.selected { background: var(--success); border-color: var(--success); color: #000; box-shadow: 0 0 10px rgba(3, 218, 198, 0.4); }
        .seat.taken { background: #1a1a1a; border-color: #222; color: #333; pointer-events: none; }
        .seat.taken::after { content: 'Ã—'; position: absolute; font-size: 20px; }

        /* èœå–®æ¨£å¼ */
        .menu-section-title { font-size: 14px; color: var(--accent); margin: 20px 0 10px 0; border-left: 3px solid var(--accent); padding-left: 10px; }
        .menu-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 12px;
            border: 1px solid #222;
        }
        .menu-item.sold-out { opacity: 0.4; pointer-events: none; filter: grayscale(1); position: relative; }
        .menu-item.sold-out::after { 
            content: 'å·²å”®å®Œ'; position: absolute; right: 20px; color: var(--danger); font-weight: bold; font-size: 12px; border: 1px solid var(--danger); padding: 2px 6px; border-radius: 4px;
        }

        .menu-controls button {
            background: #333; border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 16px;
        }
        .menu-controls span { margin: 0 12px; font-size: 16px; display: inline-block; width: 20px; text-align: center;}
        .temp-switch {
            font-size: 12px; margin-right: 8px;
            background: #222; padding: 4px 10px; border-radius: 20px; cursor: pointer; color: #666; transition: 0.3s;
        }
        .temp-switch.active { background: var(--accent); color: white; }

        /* å¾Œå° */
        .order-row { font-size: 13px; background: #222; margin-bottom: 10px; padding: 15px; border-radius: 8px; border-left: 3px solid #444; }
        .order-row.done { border-left-color: var(--success); }
        
        /* åº«å­˜ç®¡ç†æŒ‰éˆ• */
        .stock-btn { 
            padding: 5px 10px; border-radius: 4px; border: 1px solid #444; background: transparent; color: #888; font-size: 12px; cursor: pointer; margin: 2px;
        }
        .stock-btn.active { border-color: var(--success); color: var(--success); background: rgba(3, 218, 198, 0.1); }
        .stock-btn.out { border-color: var(--danger); color: var(--danger); background: rgba(207, 102, 121, 0.1); text-decoration: line-through; }

        /* STAFF ONLY é€£çµæ¨£å¼ */
        .staff-link-container {
            margin-top: auto; /* æ¨åˆ°æœ€åº•éƒ¨ */
            text-align: center;
            padding: 20px;
        }
        .staff-link {
            font-size: 10px;
            color: #333;
            letter-spacing: 2px;
            cursor: pointer;
            text-decoration: none;
            border: 1px solid #333;
            padding: 5px 10px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        .staff-link:hover {
            color: #666;
            border-color: #666;
        }

        /* Loading */
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); display:flex; justify-content:center; align-items:center; z-index: 9999; display:none; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 3px solid #333; border-top: 3px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loading">
    <div class="spinner"></div>
    <div style="color: #666; font-size: 12px;">é€£ç·šä¸­...</div>
</div>

<div id="app">
    <!-- 1. å ±åˆ°é  -->
    <div id="p-checkin" class="page active">
        <h1>I äººå¤œåº—<br><span style="font-size:12px; color:#666; letter-spacing: 5px;">INTROVERT'S NIGHT</span></h1>
        <p style="text-align: center; margin-bottom: 30px; color: #888;">è«‹é¸æ“‡æ‚¨çš„å ±åˆ°åç¨±</p>
        <div id="user-list"></div>
        
        <!-- æ–°å¢çš„ STAFF ONLY å…¥å£ -->
        <div class="staff-link-container">
            <span class="staff-link" onclick="promptAdmin()">STAFF ONLY</span>
        </div>
    </div>

    <!-- 2. æ”¯ä»˜é  -->
    <div id="p-payment" class="page">
        <h1>æ”¯ä»˜é–€ç¥¨</h1>
        <div style="background: white; padding: 30px; border-radius: 16px; text-align: center; color: #333; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
            <p style="font-size: 14px; margin: 0 0 10px 0;">é–€ç¥¨è²»ç”¨</p>
            <p style="font-size: 40px; font-weight: bold; margin: 0; color: var(--accent);">$350</p>
            <div style="margin: 20px 0; border-top: 1px dashed #ddd; border-bottom: 1px dashed #ddd; padding: 20px 0;">
                <p style="font-size: 12px; color: #666; margin-bottom: 10px;">è«‹æƒæ LinePay æˆ–æ”¯ä»˜ç¾é‡‘</p>
                <!-- æ¨¡æ“¬ QR Code -->
                <div style="width: 120px; height: 120px; background: #eee; margin: 0 auto; display: flex; align-items: center; justify-content: center; color: #aaa; border-radius: 8px;">
                    <i class="fas fa-qrcode" style="font-size: 40px;"></i>
                </div>
            </div>
            <p style="font-size: 12px; color: #888;">æ”¯ä»˜å®Œæˆå¾Œè«‹å‘å·¥ä½œäººå“¡å‡ºç¤ºæ­¤ç•«é¢</p>
        </div>
        <button class="btn staff" id="btn-staff-confirm">ã€å·¥ä½œäººå“¡ç¢ºèªã€‘æ”¯ä»˜å®Œæˆ</button>
        <button class="btn outline" style="margin-top:10px; border:none; font-size: 12px;" onclick="showPage('p-checkin')">è¿”å›é‡é¸</button>
    </div>

    <!-- 3. å€åŸŸä»‹ç´¹é  -->
    <div id="p-zones" class="page">
        <h2>é¸æ“‡æ‚¨çš„æ£²æ¯åœ°</h2>
        <p style="text-align: center; font-size: 12px; color: #666; margin-bottom: 30px;">æ¢ç´¢äº”å¤§å€åŸŸï¼Œå°‹æ‰¾å±¬æ–¼æ‚¨çš„è§’è½</p>
        <div id="zone-container"></div>
    </div>

    <!-- 4. åº§ä½é¸æ“‡é  -->
    <div id="p-seat" class="page">
        <h2 id="seat-zone-title">å€åŸŸåº§ä½</h2>
        <p style="text-align: center; font-size: 14px; color: var(--text-muted);">ç™½è‰²ç‚ºç©ºä½ï¼Œé¸å–å¾Œå°‡ä¿ç•™</p>
        
        <div class="seat-grid" id="seat-grid"></div>
        
        <div style="background: #1a1a1a; padding: 15px; border-radius: 8px; margin-top: 30px; border: 1px solid #333;">
            <p style="font-size: 12px; color: var(--danger); margin: 0; line-height: 1.6;">
                <i class="fas fa-exclamation-circle"></i> 
                è‹¥é¸å®šæ­¤ä½ç½®ï¼Œç›´åˆ°ä¸Šé¤å®Œç•¢å‰ï¼Œç„¡æ³•å†æ›´æ›ä½ç½®ã€‚
            </p>
        </div>

        <button class="btn" id="btn-confirm-seat" style="display: none;">ç¢ºèªä¸¦ä¸‹ä¸€æ­¥</button>
        <button class="btn outline" onclick="showPage('p-zones')">è¿”å›å€åŸŸç¸½è¦½</button>
    </div>

    <!-- 5. é»é¤é  -->
    <div id="p-menu" class="page">
        <h2>é¤é»é¸æ“‡</h2>
        <p style="text-align: center; font-size: 13px; color: var(--text-muted); margin-bottom: 20px;">
            è¦å‰‡ï¼šä»»é¸ 2 æ¯é£²å“ æˆ– 1 é£² 1 é¤
        </p>
        
        <div class="menu-section-title">é£²å“ Drinks</div>
        <div id="menu-drinks"></div>
        
        <div class="menu-section-title">é¤é» Food</div>
        <div id="menu-foods"></div>

        <div style="margin-top: 30px; padding: 20px; background: #1a1a1a; border-radius: 12px; text-align: center; position: sticky; bottom: 20px; border: 1px solid #333; box-shadow: 0 -5px 20px rgba(0,0,0,0.5);">
            <p style="margin: 0 0 10px 0;">ç›®å‰é¸æ“‡ï¼š<span style="color:var(--success); font-weight:bold;"><span id="select-count-drink">0</span> é£² / <span id="select-count-food">0</span> é¤</span></p>
            <button class="btn" onclick="submitOrder()">ç¢ºèªé€å‡º</button>
            <button class="btn outline" style="margin-top:10px; padding: 10px;" onclick="showPage('p-seat')">ä¸Šä¸€æ­¥</button>
        </div>
    </div>

    <!-- 6. å®Œæˆé  -->
    <div id="p-done" class="page">
        <div style="text-align: center; margin-top: 40vh; transform: translateY(-50%);">
            <h1 style="color: var(--accent-glow); margin-bottom: 10px;">I äººå¤œåº—<br>æ­¡è¿æ‚¨</h1>
            <div style="width: 50px; height: 2px; background: var(--accent); margin: 20px auto;"></div>
            <p style="line-height: 2; font-size: 16px;">è¬è¬ä»Šå¤©çš„æ‚¨å‡ºç¾åœ¨é€™è£¡<br>è®“æˆ‘å€‘éœå—¨ä¸€æ•´å¤œå§</p>
            <br>
            <p style="font-size: 12px; color: #666; margin-top: 40px;">(è«‹åœ¨åº§ä½ä¸Šç¨å€™ï¼Œé¤é»å°‡é€è‡³æ‚¨çš„åº§ä½)</p>
        </div>
    </div>

    <!-- 7. å¾Œå°ç®¡ç† -->
    <div id="p-admin" class="page">
        <h2>å¾Œå°ç®¡ç†</h2>
        
        <!-- åå–®ç®¡ç† -->
        <div style="margin-bottom: 30px; padding: 20px; background: #1a1a1a; border-radius: 12px;">
            <h3 style="font-size: 16px; margin-bottom: 10px;">å ±åˆ°åå–®è¨­å®š</h3>
            <textarea id="admin-names" placeholder="è¼¸å…¥åå­—ï¼Œä¸€è¡Œä¸€å€‹" style="width: 100%; height: 80px; background: #000; color: white; border: 1px solid #333; padding: 10px; box-sizing: border-box; border-radius: 4px;"></textarea>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="btn" onclick="adminAddUsers()" style="margin:0; padding: 10px; font-size: 14px;">æ–°å¢åå–®</button>
                <button class="btn outline" onclick="adminClearUsers()" style="margin:0; padding: 10px; font-size: 14px; color: var(--danger); border-color: var(--danger);">é‡ç½®æ´»å‹•</button>
            </div>
        </div>

        <!-- åº«å­˜ç®¡ç† -->
        <div style="margin-bottom: 30px; padding: 20px; background: #1a1a1a; border-radius: 12px;">
            <h3 style="font-size: 16px; margin-bottom: 10px;">é¤é»åº«å­˜ç®¡ç† (é»æ“Šåˆ‡æ›)</h3>
            <div id="admin-stock-list" style="display: flex; flex-wrap: wrap; gap: 5px;"></div>
        </div>

        <!-- è¨‚å–®åˆ—è¡¨ -->
        <h3 style="font-size: 16px;">å³æ™‚è¨‚å–®</h3>
        <div id="admin-orders" style="margin-bottom: 50px;"></div>
        
        <button class="btn outline" onclick="logoutAdmin()">ç™»å‡ºå¾Œå°</button>
    </div>
</div>

<script type="module">
    // --------------------------------------------------------
    // 1. FIREBASE CONFIG 
    // --------------------------------------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, set, update, get, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // ğŸ”´ è«‹å°‡æ‚¨çš„ firebaseConfig è²¼åœ¨é€™è£¡
    const firebaseConfig = {
        apiKey: "AIzaSyC856BX7Sl6iHyjDIyOwe4nh5Q1Pea-tvk",
        authDomain: "yermo-acf82.firebaseapp.com",
        projectId: "yermo-acf82",
        storageBucket: "yermo-acf82.firebasestorage.app",
        messagingSenderId: "802358752702",
        appId: "1:802358752702:web:cf4965e4784e66cf8e35ef",
        measurementId: "G-L962YRGCMQ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    // âš ï¸ ä¿®æ­£ï¼šå·²ç§»é™¤æœªè¢«å¼•ç”¨çš„ getAnalytics(app)

    // --------------------------------------------------------
    // 2. è³‡æ–™çµæ§‹èˆ‡å…¨åŸŸè®Šæ•¸
    // --------------------------------------------------------
    let currentUser = null;
    let currentSeat = null;
    let menuStatus = {}; // å„²å­˜é¤é»åº«å­˜ç‹€æ…‹

    // å€åŸŸè³‡æ–™ (å®Œå…¨ä¾ç…§éœ€æ±‚æ–‡å­—)
    const ZONES = [
        { 
            id: 1, 
            name: "ç¬¬ä¸€å€ - çªç ´è‡ªæˆ‘å€", 
            seats: 8, 
            type: "rect", // é•·æ¡Œ
            desc: `ç‹€æ…‹ï¼šä½ ä»Šå¤©çš„èƒ½é‡é©åˆäº¤æœ‹å‹å—ï¼Ÿé‚£å°±å¤§è†½é¸æ“‡é€™å€å§ï¼\n\nä»»å‹™ï¼šæ¡Œå­çš„ä¸­é–“æœ‰ç™‚ç™’å¡ï¼Œè«‹èª å¿ƒçš„å›æƒ³è‡ªå·±æœ€è¿‘çš„ç‹€æ…‹ï¼Œä¸¦æŠ½å–ä¸€å¼µå°å¡ï¼Œå°‡å…§å®¹å¯«åœ¨ç´™ä¸Šï¼Œä¸¦èˆ‡é„°è¿‘çš„äººäº¤æ›ç‹€æ…‹ï¼\n\næé†’ï¼šæœ‰æ™‚å€™çªç ´æ˜¯éœ€è¦ä¸€é»å‹‡æ°£ï¼Œè€Œä»Šå¤©çš„ä½ é¸æ“‡é€™è£¡å°±å·²å……æ»¿å‹‡æ°£ï¼Œæ‰€ä»¥ä¸è¦å®³æ€•ç•¶ä¸»å‹•çš„é‚£å€‹äººï¼Œèªªä¸å®šæœƒå¾—åˆ°æ„å¤–çš„æ”¶ç©«å”·ï¼` 
        },
        { 
            id: 2, 
            name: "ç¬¬äºŒå€ - è‡ªç”±æ¼‚æµå€", 
            seats: 8, // åœ“æ¡Œ6 + é‚Šæ¡Œ2
            type: "round", 
            desc: `ç‹€æ…‹ï¼šä»Šå¤©çš„èƒ½é‡å·²ç¶“è€—ç›¡äº†å—ï¼Ÿè«‹å¾é‡é™Œç²å¾—ç™‚ç™’çš„åŠ›é‡å§ï¼\n\nä»»å‹™ï¼šæ”¾ç©ºä¹Ÿå¥½ã€è½éŸ³æ¨‚ä¹Ÿè¡Œï¼Œåç´¯äº†å°±èµ·ä¾†æ™ƒæ™ƒå§ï¼æ•´æ£Ÿå»ºç¯‰ç‰©éƒ½å¯ä»¥ç›¡æƒ…æ¢ç´¢ï½\n\næé†’ï¼šäºŒæ¨“æœ‰å€‹ç¥ç§˜çš„é–€ï¼Œæ‰“é–‹å¾Œæ˜¯å€‹èƒ½å¤ å¥½å¥½å‘¼å¸çš„éœ²å°ï¼›ä¸‰æ¨“å‰‡æ˜¯æ¤ç‰©çš„å®¶ï¼Œå¯ä»¥å››è™•ç§ç§ï¼` 
        },
        { 
            id: 3, 
            name: "ç¬¬ä¸‰å€ - çœ‹æ›¸å…±å­˜å€", 
            seats: 6, // æ²™ç™¼4 + é‚Šæ¡Œ2
            type: "sofa", 
            desc: `ç‹€æ…‹ï¼šä¸€ç›´æ²’æœ‰ç©ºé–“å¥½å¥½çœ‹æ›¸ï¼Ÿé‚£å°±é¸ä¸€å€‹ä½ å–œæ­¡çš„ä½ç½®ï¼Œå°‡æ›¸æ‰“é–‹å§ï¼\n\nä»»å‹™ï¼šä»»å‹™é–‹å§‹å‰è«‹å°ˆå¿ƒçœ‹æ›¸ï¼Œæˆ‘å€‘å°‡æ–¼22:00 é‚€è«‹å¤§å®¶åˆ†äº«ä»Šå¤©å¸¶ä¾†çš„æ˜¯ä»€éº¼æ›¸ï¼›è‹¥ä¸æƒ³åƒèˆ‡å¯æ–¼æ´»å‹•å‰æ›´æ›ä½ç½®ã€‚\n\næé†’ï¼šå„çœ‹å„çš„æ›¸å†å½¼æ­¤æ¨è–¦å°±æ˜¯æœ€é©åˆiäººçš„è®€æ›¸æœƒï¼Œç°¡å–®çš„åˆ†äº«ä¹Ÿæ˜¯åˆ†äº«ï¼Œä¸€åˆ‡æ´»å‹•çš†æ¡é¼“å‹µåˆ¶ï¼Œè«‹ä¸è¦æœ‰å£“åŠ›ï¼` 
        },
        { 
            id: 4, 
            name: "ç¬¬å››å€ - å·¥ä½œå¯«å­—å€", 
            seats: 6, // 3å€‹æœ¨æ¡Œ * 2
            type: "rect", 
            desc: `ç‹€æ…‹ï¼šä½ ä»Šå¤©çš„å·¥ä½œæˆ–è®€æ›¸ç›®æ¨™å°šæœªé”æˆå—ï¼Ÿè¾›è‹¦ä½ äº†ï¼è®“æˆ‘å€‘ä¸€èµ·åŠ æ²¹åŠ æ²¹ï½\n\nä»»å‹™ï¼šä»Šæ—¥é€²åº¦æœªå®Œæˆå‰ï¼Œè«‹ä¿æŒå®‰éœã€‚\nåš´ç¦è¬›è©±åŠäº¤è«‡ï¼\n\næé†’ï¼šè‹¥éœ€è¦æ‰‹æ©Ÿä»£ä¿ç®¡æœå‹™ï¼Œè«‹æ‰¾è€é—†ï¼` 
        },
        { 
            id: 5, 
            name: "ç¬¬äº”å€ - å†¥æƒ³å åœå€", 
            seats: 8, // 2åœ“æ¡Œ*2 + 2æ–¹æ¡Œ*2 = 8ä½
            type: "mix", 
            desc: `ç‹€æ…‹ï¼šæœ€è¿‘éå¸¸è¿·æƒ˜å—ï¼Ÿæˆ–è€…é²é²ç„¡æ³•æ”¾é¬†ä¸‹ä¾†å‘¢ï¼Ÿæˆ´ä¸Šå¦³çš„è€³æ©Ÿï¼Œé€²å…¥ç¥å¥‡çš„ä¸–ç•Œå§ï¼\n\nä»»å‹™ï¼šè€é—†æœƒå°‡é©åˆæ‚¨çš„å½±ç‰‡å‚³çµ¦æ‚¨ï¼Œè«‹è·Ÿéš¨å½±ç‰‡çš„å…§å®¹é€²è¡Œä»Šæ—¥çš„ä»»å‹™ï¼\n\næé†’ï¼šä¸€å®šè¦æˆ´ä¸Šä½ çš„è€³æ©Ÿï¼Œè«‹å‹¿å½±éŸ¿ä»–äººã€‚` 
        }
    ];

    const MENU = {
        drinks: ["ç¾å¼", "æ‹¿éµ", "å¯å¯ç‰›å¥¶", "é»‘ç³–é®®å¥¶", "ä¼¯çˆµèŒ¶", "æ´‹ç”˜èŠèŒ¶(åƒ…ç†±)"],
        foods: ["ç´°è–¯æ¢", "è‚‰æ¡‚æ²", "ææ‹‰ç±³è˜‡"]
    };

    // --------------------------------------------------------
    // 3. é é¢é‚è¼¯
    // --------------------------------------------------------
    
    // åˆå§‹åŒ–ï¼šç›£è½å ±åˆ°åå–®
    const usersRef = ref(db, 'users');
    onValue(usersRef, (snapshot) => {
        const users = snapshot.val() || {};
        const listDiv = document.getElementById('user-list');
        listDiv.innerHTML = '';
        
        const sortedNames = Object.keys(users).sort();
        
        if (sortedNames.length === 0) {
            listDiv.innerHTML = '<p style="text-align:center; color:#444;">(ç›®å‰ç„¡å¾…å ±åˆ°åå–®ï¼Œè«‹ç¨å€™)</p>';
            return;
        }

        sortedNames.forEach(name => {
            const status = users[name].status || 'waiting'; // waiting, paid, done
            if (status === 'waiting') {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.textContent = name;
                div.onclick = () => selectUser(name);
                listDiv.appendChild(div);
            }
        });
    });

    // ç›£è½åº«å­˜ç‹€æ…‹
    onValue(ref(db, 'menu_status'), (snapshot) => {
        menuStatus = snapshot.val() || {};
        // å¦‚æœç›®å‰åœ¨èœå–®é ï¼Œå³æ™‚æ›´æ–°
        if(document.getElementById('p-menu').classList.contains('active')) {
            renderMenu();
        }
        // å¦‚æœåœ¨å¾Œå°ï¼Œæ›´æ–°åº«å­˜åˆ—è¡¨
        if(document.getElementById('p-admin').classList.contains('active')) {
            renderAdminStock();
        }
    });

    window.selectUser = (name) => {
        if(!confirm(`ç¢ºèªæ‚¨æ˜¯ ${name} å—ï¼Ÿ`)) return;
        currentUser = name;
        showPage('p-payment');
    };

    // æ”¯ä»˜é é¢
    document.getElementById('btn-staff-confirm').onclick = () => {
        // å·¥ä½œäººå“¡ç¢ºèª
        update(ref(db, 'users/' + currentUser), { status: 'paid' });
        showPage('p-zones');
    };

    // å€åŸŸé¡¯ç¤º
    const zoneContainer = document.getElementById('zone-container');
    ZONES.forEach(zone => {
        const div = document.createElement('div');
        div.className = 'zone-card';
        div.innerHTML = `
            <div class="zone-title">${zone.name}</div>
            <div class="zone-desc">${zone.desc}</div>
            <button class="btn outline" style="margin-top:10px; padding:12px; border-radius:8px;" onclick="openZone(${zone.id})">
                é¸æ“‡æ­¤å€åº§ä½ <i class="fas fa-arrow-right"></i>
            </button>
        `;
        zoneContainer.appendChild(div);
    });

    window.openZone = (zoneId) => {
        const zone = ZONES.find(z => z.id === zoneId);
        document.getElementById('seat-zone-title').textContent = zone.name;
        document.getElementById('btn-confirm-seat').style.display = 'none';
        
        // æ¸²æŸ“åº§ä½
        const grid = document.getElementById('seat-grid');
        grid.innerHTML = '';
        
        onValue(ref(db, 'seats'), (snapshot) => {
            const allSeats = snapshot.val() || {};
            grid.innerHTML = ''; 
            
            for(let i=1; i<=zone.seats; i++) {
                const seatId = `${zoneId}-${i}`;
                const btn = document.createElement('div');
                btn.className = 'seat';
                btn.textContent = i;
                
                // ç¬¬äº”å€æœ‰åœ“æ¡Œæœ‰æ–¹æ¡Œçš„è¦–è¦ºå€åˆ† (å‰4åœ“, å¾Œ4æ–¹)
                if (zoneId === 5 && i > 4) btn.classList.add('square'); 
                else if (zone.type === 'rect') btn.classList.add('square');

                if (allSeats[seatId] && allSeats[seatId].takenBy && allSeats[seatId].takenBy !== currentUser) {
                    btn.classList.add('taken');
                    btn.title = "å·²æœ‰äºº";
                } else {
                    btn.onclick = () => selectSeatTemp(seatId, btn);
                }
                
                // ä¿æŒç•¶å‰é¸æ“‡
                if (currentSeat === seatId) btn.classList.add('selected');
                
                grid.appendChild(btn);
            }
        }, { onlyOnce: true }); // åˆæ¬¡è¼‰å…¥
        
        showPage('p-seat');
    };

    window.selectSeatTemp = (seatId, btnElement) => {
        document.querySelectorAll('.seat').forEach(s => s.classList.remove('selected'));
        btnElement.classList.add('selected');
        currentSeat = seatId;
        document.getElementById('btn-confirm-seat').style.display = 'block';
    };

    document.getElementById('btn-confirm-seat').onclick = async () => {
        // äºŒæ¬¡æª¢æŸ¥åº§ä½
        const seatRef = ref(db, 'seats/' + currentSeat);
        const snapshot = await get(seatRef);
        if (snapshot.exists() && snapshot.val().takenBy !== currentUser) {
            alert('å“å‘€ï¼å‰›å‰›æœ‰äººæ¯”æ‚¨å¿«ä¸€æ­¥é¸äº†é€™å€‹ä½ç½®ï¼Œè«‹é‡é¸ã€‚');
            const zoneId = parseInt(currentSeat.split('-')[0]);
            openZone(zoneId);
            return;
        }

        // é–å®šåº§ä½
        await set(seatRef, { takenBy: currentUser });
        await update(ref(db, 'users/' + currentUser), { seat: currentSeat });
        
        renderMenu();
        showPage('p-menu');
    };

    // èœå–®é‚è¼¯
    let orderState = {}; 

    function renderMenu() {
        const dContainer = document.getElementById('menu-drinks');
        const fContainer = document.getElementById('menu-foods');
        dContainer.innerHTML = '';
        fContainer.innerHTML = '';
        
        // ä¿ç•™å·²é¸æ•¸é‡ï¼Œé‡æ–°æ¸²æŸ“åˆ—è¡¨
        const oldState = {...orderState};
        orderState = {}; 

        // æ¸²æŸ“é£²å“
        MENU.drinks.forEach(item => {
            // åˆå§‹åŒ– state (å¦‚æœæœ‰èˆŠè³‡æ–™å‰‡æ²¿ç”¨)
            const isHotOnly = item.includes('åƒ…ç†±');
            if (oldState[item]) {
                orderState[item] = oldState[item];
            } else {
                orderState[item] = { type: 'drink', temp: isHotOnly?'hot':'ice', count: 0 };
            }

            // æª¢æŸ¥å®Œå”®
            const isSoldOut = menuStatus[item] === false; // false ä»£è¡¨å®Œå”®

            const div = document.createElement('div');
            div.className = `menu-item ${isSoldOut ? 'sold-out' : ''}`;
            
            div.innerHTML = `
                <div>
                    <div style="font-weight:bold; font-size:16px;">${item}</div>
                    <div style="margin-top:8px;">
                        ${!isHotOnly ? `<span class="temp-switch ${orderState[item].temp==='ice'?'active':''}" onclick="toggleTemp('${item}', 'ice', this)">å†°</span>` : ''}
                        <span class="temp-switch ${isHotOnly||orderState[item].temp==='hot'?'active':''}" onclick="toggleTemp('${item}', 'hot', this)">ç†±</span>
                    </div>
                </div>
                <div class="menu-controls">
                    <button onclick="changeCount('${item}', 'drink', -1)">-</button>
                    <span id="count-${item}">${orderState[item].count}</span>
                    <button onclick="changeCount('${item}', 'drink', 1)">+</button>
                </div>
            `;
            dContainer.appendChild(div);
        });

        // æ¸²æŸ“é¤é»
        MENU.foods.forEach(item => {
            if (oldState[item]) {
                orderState[item] = oldState[item];
            } else {
                orderState[item] = { type: 'food', temp: null, count: 0 };
            }

            const isSoldOut = menuStatus[item] === false;

            const div = document.createElement('div');
            div.className = `menu-item ${isSoldOut ? 'sold-out' : ''}`;
            div.innerHTML = `
                <div style="font-weight:bold; font-size:16px;">${item}</div>
                <div class="menu-controls">
                    <button onclick="changeCount('${item}', 'food', -1)">-</button>
                    <span id="count-${item}">${orderState[item].count}</span>
                    <button onclick="changeCount('${item}', 'food', 1)">+</button>
                </div>
            `;
            fContainer.appendChild(div);
        });
        
        updateCartDisplay();
    }

    window.toggleTemp = (name, temp, btn) => {
        const parent = btn.parentNode;
        parent.querySelectorAll('.temp-switch').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        orderState[name].temp = temp;
    };

    window.changeCount = (name, type, delta) => {
        const newState = orderState[name].count + delta;
        if (newState < 0) return;
        
        // è¦å‰‡æª¢æŸ¥: 2é£² æˆ– 1é£²1é¤
        // å…ˆç®—ç›®å‰ç¸½æ•¸ (æ‰£é™¤ç•¶å‰é …ç›®èˆŠæ•¸é‡)
        let currentDrink = 0;
        let currentFood = 0;
        Object.keys(orderState).forEach(key => {
            if (key !== name) {
                if(orderState[key].type === 'drink') currentDrink += orderState[key].count;
                if(orderState[key].type === 'food') currentFood += orderState[key].count;
            }
        });

        // åŠ å…¥æ–°æ•¸é‡é åˆ¤
        if (type === 'drink') currentDrink += newState;
        if (type === 'food') currentFood += newState;

        // åˆ¤æ–·
        const total = currentDrink + currentFood;
        
        if (delta > 0) { // å¢åŠ æ™‚æ‰æª¢æŸ¥ä¸Šé™
            if (total > 2) { alert('æœ€å¤šé¸æ“‡å…©é …ï¼'); return; }
            if (currentFood > 1) { alert('é¤é»æœ€å¤šåªèƒ½é¸ä¸€ä»½å–”ï¼'); return; }
            if (currentDrink === 0 && currentFood === 2) { alert('ä¸èƒ½é¸å…©ä»½é¤é»ï¼Œè«‹æ­é…é£²æ–™ï¼'); return; } 
        }

        orderState[name].count = newState;
        document.getElementById(`count-${name}`).textContent = newState;
        updateCartDisplay();
    };

    function updateCartDisplay() {
        let d = 0, f = 0;
        Object.values(orderState).forEach(o => {
            if(o.type === 'drink') d += o.count;
            if(o.type === 'food') f += o.count;
        });
        document.getElementById('select-count-drink').textContent = d;
        document.getElementById('select-count-food').textContent = f;
    }

    window.submitOrder = async () => {
        let d = 0, f = 0;
        let items = [];
        Object.keys(orderState).forEach(key => {
            const o = orderState[key];
            if (o.count > 0) {
                if(o.type === 'drink') d += o.count;
                if(o.type === 'food') f += o.count;
                items.push({ 
                    name: key, 
                    count: o.count, 
                    temp: o.temp, 
                    type: o.type 
                });
            }
        });

        // æœ€çµ‚è¦å‰‡æª¢æŸ¥
        if ((d === 2 && f === 0) || (d === 1 && f === 1)) {
            // åˆæ ¼
        } else {
            alert('è«‹é¸æ“‡ï¼šå…©æ¯é£²å“ æˆ– ä¸€é£²ä¸€é¤'); return;
        }

        document.getElementById('loading').style.display = 'flex';
        
        try {
            await set(ref(db, 'orders/' + currentUser), {
                seat: currentSeat,
                items: items,
                timestamp: Date.now()
            });
            await update(ref(db, 'users/' + currentUser), { status: 'done' });
            
            document.getElementById('loading').style.display = 'none';
            showPage('p-done');
        } catch(e) {
            alert("é€£ç·šéŒ¯èª¤ï¼Œè«‹é‡è©¦");
            document.getElementById('loading').style.display = 'none';
        }
    };


    // --------------------------------------------------------
    // 4. å¾Œå°é‚è¼¯
    // --------------------------------------------------------
    window.promptAdmin = () => {
        const pwd = prompt("è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼");
        if (pwd === "13491349") {
            showPage('p-admin');
            loadAdminData();
            renderAdminStock();
        } else if (pwd !== null) {
            alert("å¯†ç¢¼éŒ¯èª¤");
        }
    };

    // [ä¿®æ­£ 1] æ–°å¢åå–®ï¼šå¢åŠ éŒ¯èª¤è™•ç†èˆ‡åç¨±éæ¿¾
    window.adminAddUsers = async () => {
        const text = document.getElementById('admin-names').value;
        // éæ¿¾ç©ºè¡Œ
        const names = text.split('\n')
            .map(n => n.trim())
            .filter(n => n !== '');
        
        if (names.length === 0) {
            alert("è«‹è¼¸å…¥è‡³å°‘ä¸€å€‹åå­—");
            return;
        }
        
        const updates = {};
        names.forEach(n => {
            // ä¿®æ­£ï¼šFirebase Key ä¸èƒ½åŒ…å« . # $ [ ] / 
            // ç°¡å–®è™•ç†ï¼šå°‡é€™äº›ç¬¦è™Ÿæ›¿æ›ç‚ºåº•ç·šï¼Œé¿å…å¯«å…¥å¤±æ•—
            const safeName = n.replace(/[.#$[\]\/]/g, "_");
            updates[safeName] = { status: 'waiting' };
        });

        try {
            await update(ref(db, 'users'), updates);
            alert(`æˆåŠŸæ–°å¢ ${Object.keys(updates).length} ä½åå–®`);
            document.getElementById('admin-names').value = '';
        } catch (error) {
            console.error(error);
            // é¡¯ç¤ºå…·é«”éŒ¯èª¤ï¼Œå¹«åŠ©æ’é™¤å•é¡Œ (ä¾‹å¦‚ Permission Denied)
            alert("æ–°å¢å¤±æ•—: " + error.message + "\nè«‹æª¢æŸ¥ Firebase æ¬Šé™è¨­å®š (Rules)ã€‚");
        }
    };
    
    window.adminClearUsers = async () => {
        if(confirm("è­¦å‘Šï¼šç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿ\né€™æœƒåˆªé™¤æ‰€æœ‰è¨‚å–®ã€åº§ä½ç‹€æ…‹å’Œå ±åˆ°åå–®ã€‚")) {
            try {
                await set(ref(db, 'users'), null);
                await set(ref(db, 'seats'), null);
                await set(ref(db, 'orders'), null);
                // menu_status ä¸æ¸…ç©ºï¼Œä¿ç•™åº«å­˜è¨­å®š
                alert("æ´»å‹•å·²é‡ç½®");
            } catch (error) {
                alert("é‡ç½®å¤±æ•—: " + error.message);
            }
        }
    };

    function loadAdminData() {
        onValue(ref(db, 'orders'), (snapshot) => {
            const orders = snapshot.val() || {};
            const container = document.getElementById('admin-orders');
            container.innerHTML = '';
            
            const orderList = Object.entries(orders).sort((a,b) => b[1].timestamp - a[1].timestamp);

            if(orderList.length === 0) {
                container.innerHTML = '<div style="color:#666; text-align:center;">å°šç„¡è¨‚å–®</div>';
                return;
            }

            orderList.forEach(([user, data]) => {
                const div = document.createElement('div');
                div.className = 'order-row';
                
                let itemStr = '';
                data.items.forEach(i => {
                    const tempStr = i.type==='drink' ? (i.temp==='ice'?'<span style="color:#03dac6">[å†°]</span>':'<span style="color:#cf6679">[ç†±]</span>') : '';
                    itemStr += `<div style="margin-left:10px; margin-top:5px;">â€¢ ${i.name} ${tempStr} x${i.count}</div>`;
                });

                // æ›ç®—æ™‚é–“
                const time = new Date(data.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-size:16px; color:var(--accent-glow); font-weight:bold;">${user}</span>
                        <span style="font-size:12px; color:#aaa;">${time}</span>
                    </div>
                    <div style="font-size:12px; color:#ccc; margin-bottom:5px;">åº§ä½: ${data.seat}</div>
                    <div style="border-top:1px solid #444; padding-top:5px;">${itemStr}</div>
                `;
                container.appendChild(div);
            });
        });
    }

    // [ä¿®æ­£ 2] åº«å­˜æ¸²æŸ“ï¼šå¢åŠ é»æ“ŠéŒ¯èª¤è™•ç†
    function renderAdminStock() {
        const container = document.getElementById('admin-stock-list');
        container.innerHTML = '';
        
        const allItems = [...MENU.drinks, ...MENU.foods];
        
        allItems.forEach(item => {
            const isAvailable = menuStatus[item] !== false; // default true
            const btn = document.createElement('button');
            btn.className = `stock-btn ${isAvailable ? 'active' : 'out'}`;
            btn.textContent = `${item} ${isAvailable ? '(è²©å”®ä¸­)' : '(å®Œå”®)'}`;
            
            btn.onclick = async () => {
                try {
                    await update(ref(db, 'menu_status'), {
                        [item]: !isAvailable
                    });
                } catch (error) {
                    console.error(error);
                    alert("æ›´æ–°ç‹€æ…‹å¤±æ•—: " + error.message + "\nè«‹æª¢æŸ¥ Firebase æ¬Šé™è¨­å®š (Rules)ã€‚");
                }
            };
            container.appendChild(btn);
        });
    }

    window.logoutAdmin = () => {
        showPage('p-checkin');
    }

    window.showPage = (id) => {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        window.scrollTo(0,0);
    };

</script>
</body>
</html>